name: PCB Release

on:
  workflow_call:

permissions:
  contents: read
  id-token: write

jobs:
  detect:
    name: Detect boards
    runs-on: ubuntu-latest
    outputs:
      boards: ${{ steps.detect.outputs.boards }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install pcb
        uses: diodeinc/pcb-action/setup@97d21fc143d97e517081b054a30dc76f979d737e

      - name: Detect boards
        id: detect
        uses: diodeinc/pcb-action/detect@97d21fc143d97e517081b054a30dc76f979d737e

  release:
    name: Release ${{ matrix.board }}
    needs: detect
    runs-on: ubuntu-latest
    container:
      image: kicad/kicad:9.0.3
      options: --user root
    strategy:
      fail-fast: false
      matrix:
        board: ${{ fromJSON(needs.detect.outputs.boards) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install dependencies
        run: apt-get update && apt-get install -y curl jq git

      - name: Fix git permissions
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Install pcb
        uses: diodeinc/pcb-action/setup@97d21fc143d97e517081b054a30dc76f979d737e

      - name: Release
        id: release
        uses: diodeinc/pcb-action/release@97d21fc143d97e517081b054a30dc76f979d737e
        with:
          board: ${{ matrix.board }}

      - name: Sign
        uses: diodeinc/pcb-action/sign@97d21fc143d97e517081b054a30dc76f979d737e
        with:
          path: ${{ steps.release.outputs.archive_path }}
