name: "Setup PCB CLI"
description: "Install the pcb CLI tool on the runner"
author: "Diode Inc."

inputs:
  version:
    description: "Version of pcb CLI to install (default: latest)"
    required: false
    default: "latest"

runs:
  using: "composite"
  steps:
    - name: Setup GitHub CLI
      uses: wusatosi/setup-gh@v1

    - name: Install pcb CLI
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        set -e -o pipefail
        if [ "${{ inputs.version }}" = "HEAD" ]; then
          # Download latest main build from prerelease
          mkdir -p ~/.cargo/bin
          gh release download latest --repo diodeinc/pcb --pattern pcb --dir ~/.cargo/bin
          chmod +x ~/.cargo/bin/pcb
        elif [ "${{ inputs.version }}" = "latest" ]; then
          curl --proto '=https' --tlsv1.2 -LsSf https://github.com/diodeinc/pcb/releases/latest/download/pcb-installer.sh | sh
        else
          curl --proto '=https' --tlsv1.2 -LsSf https://github.com/diodeinc/pcb/releases/download/${{ inputs.version }}/pcb-installer.sh | sh
        fi
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        export PATH="$HOME/.cargo/bin:$PATH"
        pcb --version
